resources:
  - name: app-repo
    type: git
    source:
      uri: https://github.com/savaseeratesli/PipelineExamples.git
      branch: main

jobs:
  # --- JOB 1: Docker image build + push ---
  - name: build-and-push
    plan:
      - get: app-repo
        trigger: true
      - task: build-image
        privileged: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: docker }
          inputs:
            - name: app-repo
          run:
            path: sh
            args:
              - -exc
              - |
                cd app-repo
                TAG=$(date +%Y%m%d%H%M%S)
                echo "ğŸ”¥ Building image savaseeratesli/simple-image:$TAG ..."
                docker build -t savaseeratesli/simple-image:$TAG .
                docker push savaseeratesli/simple-image:$TAG
                echo $TAG > ../image-tag.txt
        outputs:
          - name: app-repo
          - name: image-tag
      - put: app-repo
        params: { file: image-tag.txt }

  # --- JOB 2: Kubernetes'e deploy et ---
  - name: deploy-to-kubernetes
    plan:
      - get: app-repo
        passed: [build-and-push]
        trigger: true

      - task: deploy
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: bitnami/kubectl
              tag: latest
          inputs:
            - name: app-repo
          run:
            path: sh
            args:
              - -exc
              - |
                echo "ğŸš€ Deploying new image to Kubernetes..."
                TAG=$(cat app-repo/image-tag.txt)

                echo "ğŸ” Updating deployment to image: savaseeratesli/simple-image:$TAG"
                kubectl set image deployment/hello-ziraat hello-ziraat=savaseeratesli/simple-image:$TAG --record

                echo "âœ… New image applied!"
