resources:
- name: app-repo
  type: git
  source:
    uri: https://github.com/savaseeratesli/PipelineExamples.git
    branch: main

jobs:
- name: build-and-push
  plan:
  - get: app-repo
    trigger: true

  - task: build-docker
    privileged: true
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: docker
      inputs:
      - name: app-repo
      params:
        DOCKERHUB_USERNAME: ((dockerhub_username))
        DOCKERHUB_PASSWORD: ((dockerhub_password))
      run:
        path: sh
        args:
          - -exc
          - |
            cd app-repo
            echo "ðŸ”¹ Docker imajÄ± oluÅŸturuluyor..."
            docker build -t savaseeratesli/test:latest .
            echo "ðŸ”¹ DockerHub'a giriÅŸ yapÄ±lÄ±yor..."
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            echo "ðŸ”¹ Ä°maj DockerHub'a gÃ¶nderiliyor..."
            docker push savaseeratesli/test:latest

- name: deploy-to-k8s
  plan:
  - get: app-repo
    passed: [build-and-push]
    trigger: true

  - task: apply-k8s
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: bitnami/kubectl
      inputs:
      - name: app-repo
      params:
        KUBECONFIG: ((kubeconfig))
      run:
        path: sh
        args:
          - -exc
          - |
            cd app-repo
            echo "ðŸ”¹ Kubernetes manifestleri uygulanÄ±yor..."
            kubectl apply -f deployment.yml
            kubectl apply -f service.yml
            kubectl apply -f hpa.yml
